import{r as o,u as de,j as e,G as l,T as p,M as P,L as _,a as O,b as q,B as g,I as G,R as me,A as H,C as he,c as V,d as ue}from"./index-mIG69d0_.js";import{A as C}from"./AnalyticEcommerce-CdmpmBJb.js";import{F as fe}from"./index.es-B27EdhAD.js";import{A as $,f as xe,R as pe}from"./index-BJ3syGe5.js";import{a as D}from"./index-SPfG3NXw.js";import{R as ge}from"./EyeInvisibleOutlined-CF3u7301.js";import{R as be}from"./CopyOutlined-COvlQqIK.js";const J={WhatsApp:{hoverBg:"#25D366",color:"#fff"},Signal:{hoverBg:"#3A76F0",color:"#fff"}},A={WhatsApp:e.jsx(pe,{style:{color:"#25D366"}}),Signal:e.jsx(fe,{icon:xe,style:{color:"#3A76F0"}})},E="https://sherlockwisdom.com:8080",ye="wss://sherlockwisdom.com:8090";function Ke(){const z=localStorage.getItem("token"),T=localStorage.getItem("username")||"User",u=localStorage.getItem("token")||"",X=u?1:0,[Y,B]=o.useState(""),[W,Z]=o.useState(!1),[ee,K]=o.useState(!1),[j,R]=o.useState(""),[je,Q]=o.useState(""),[L,b]=o.useState(""),[k,c]=o.useState(""),[U,y]=o.useState(null),[F,i]=o.useState(!1),[M,ke]=o.useState(null),[S,se]=o.useState([]),[Se,te]=o.useState(""),[we,ve]=o.useState(!1),[Ae,We]=o.useState(""),[Re,w]=o.useState([]),[Ie,Pe]=o.useState(!1),r=o.useRef(null);de();const N=async()=>{const s=localStorage.getItem("token"),n=localStorage.getItem("username")||"User",d={accept:"application/json","Content-Type":"application/json",Authorization:`Bearer ${s}`},h={wa:"WhatsApp",signal:"Signal"},a=[];await Promise.all(Object.keys(h).map(async m=>{var v;try{const f=await D.post(`${E}/${m}/list/devices`,{username:n},{headers:d});console.log(`${m.toUpperCase()} devices:`,f.data),(((v=f.data)==null?void 0:v.devices)||[]).forEach(x=>{a.push({platform:h[m],id:x})})}catch(f){console.error(`Error fetching ${m} devices`,f)}})),se(a)};o.useEffect(()=>{N()},[]);const oe=s=>{navigator.clipboard.writeText(s),B(s),setTimeout(()=>B(""),1500)},re=()=>{Z(!W)},ae=()=>{K(!0),R(""),b(""),c(""),y(null),i(!1),r.current&&(r.current.close(),r.current=null)},ne=async s=>{var n,d,h;R(s),Q(s),b(""),c(""),y(null),i(!0),M&&clearTimeout(M);try{let a=s.toLowerCase();a==="whatsapp"&&(a="wa");const m=`${E}/${a}/devices`,v={username:T},f=await D.post(m,v,{headers:{accept:"application/json","Content-Type":"application/json",Authorization:`Bearer ${z}`}});if(b("Waiting for QR code..."),(n=f.data)!=null&&n.websocket_url){let x=f.data.websocket_url;x.startsWith("/")&&(x=`${ye}${x}`);try{r.current=new window.WebSocket(x),r.current.binaryType="blob",r.current.onopen=()=>{console.log("WebSocket connected successfully to:",x)},r.current.onmessage=t=>{if(i(!1),!t.data||t.data.length===0){console.log("Received nil or empty data, closing WebSocket connection."),r.current&&r.current.readyState===WebSocket.OPEN&&r.current.close(),c("End of session or error: No data received. Please try again.");return}if(console.log("WebSocket received data:",t.data),t.data instanceof Blob){const I=new FileReader;I.onload=function(le){y(le.target.result),b("QR code received successfully!")},I.onerror=function(){c("Error reading binary image data."),i(!1)},I.readAsDataURL(t.data)}else typeof t.data=="string"?(t.data.startsWith("data:image/")?y(t.data):y(`data:image/png;base64,${t.data}`),b("QR code received successfully!")):(c("Received unsupported data type for QR code."),i(!1))},r.current.onerror=t=>{console.error("WebSocket error:",t),c("WebSocket connection failed. Please ensure the backend WebSocket endpoint is running and accessible."),i(!1)},r.current.onclose=t=>{console.log("WebSocket closed:",t),!t.wasClean&&t.code!==1e3&&c(`WebSocket closed unexpectedly (code: ${t.code}, reason: ${t.reason})`),i(!1)}}catch(t){console.error("WebSocket connection attempt error:",t),c("WebSocket connection error. Please check your backend and network."),i(!1)}}else c("WebSocket URL not provided by the server."),i(!1)}catch(a){console.error("API call failed:",a),(h=(d=a.response)==null?void 0:d.data)!=null&&h.message?c(a.response.data.message):c(a.message||"Failed to add device"),i(!1)}},ce=()=>{K(!1),R(""),Q(""),b(""),c(""),y(null),i(!1),r.current&&(r.current.close(),r.current=null),N()},ie=new Set(S.map(s=>s.platform));return o.useEffect(()=>{D.get(`${E}/webhook`,{headers:{accept:"application/json","Content-Type":"application/json",Authorization:`Bearer ${z}`}}).then(s=>{var n,d;Array.isArray(s.data)?w(s.data):(n=s.data)!=null&&n.webhooks?w(s.data.webhooks):(d=s.data)!=null&&d.url?w([s.data.url]):w([]),te("")})},[]),e.jsxs(l,{container:!0,rowSpacing:4.5,columnSpacing:2.75,children:[e.jsx(l,{sx:{mb:1},size:12,children:e.jsxs(p,{variant:"h5",sx:{textTransform:"capitalize"},children:["Hi ",`, ${T}`,"!👋🏼"]})}),e.jsx(l,{size:{xs:12,sm:6,md:2,lg:2},children:e.jsx(C,{title:"Platforms",count:ie.size,extra:"Number of Platforms"})}),e.jsx(l,{size:{xs:12,sm:6,md:2,lg:2},children:e.jsx(C,{title:"Devices",count:S.length,extra:"Number of Devices"})}),e.jsx(l,{size:{xs:12,sm:6,md:2,lg:2},children:e.jsx(C,{title:"API Keys",count:X,extra:"Number of API Keys"})}),e.jsx(l,{size:{xs:12,md:12,lg:12},children:e.jsx(P,{title:"API Key",children:u?e.jsx(_,{children:e.jsx(O,{secondaryAction:e.jsxs(g,{sx:{display:"flex",alignItems:"center",gap:1,ml:2},children:[e.jsx(G,{sx:{color:"black",minWidth:40},edge:"end","aria-label":"toggle visibility",onClick:re,children:W?e.jsx(ge,{}):e.jsx(me,{})}),e.jsx(G,{sx:{color:"black",minWidth:40},edge:"end","aria-label":"copy",onClick:()=>oe(u),children:e.jsx(be,{})})]}),sx:{pl:0,pr:12},children:e.jsx(q,{primary:W?u:"•".repeat(Math.min(u.length,40)),secondary:Y===u?"Copied!":null,sx:{wordBreak:"break-all",mr:2,maxWidth:"calc(100% - 120px)"}})},u)}):e.jsx(p,{variant:"body2",color:"text.secondary",children:"No API key found."})})}),ee&&e.jsx(l,{size:12,children:e.jsx(g,{sx:{mb:4,p:2,border:"1px solid #eee",borderRadius:2,bgcolor:"background.paper"},children:j?e.jsxs(e.Fragment,{children:[F&&e.jsxs(g,{sx:{display:"flex",flexDirection:"column",alignItems:"center",mb:2},children:[e.jsx(he,{sx:{mb:2}}),e.jsx(p,{variant:"body2",children:"Waiting for QR code from device..."})]}),!F&&U?e.jsxs(g,{sx:{textAlign:"center",mb:2},children:[e.jsx(p,{variant:"subtitle1",sx:{mb:1},children:"Scan this QR Code with your device"}),e.jsx(g,{sx:{display:"inline-block",background:"#fff",border:"4px solid #1976d2",borderRadius:2,p:2,boxShadow:2},children:e.jsx("img",{src:U,alt:"QR Code",style:{width:320,height:320,maxWidth:"90vw",maxHeight:"90vw",imageRendering:"pixelated",background:"#fff",display:"block"}})})]}):null,e.jsx(V,{variant:"contained",color:"success",sx:{mt:2},onClick:ce,children:"Done"}),k&&e.jsx($,{severity:"error",sx:{mt:2},children:k})]}):e.jsxs(e.Fragment,{children:[e.jsx(p,{variant:"subtitle1",sx:{mb:2},children:"Select a platform to add"}),e.jsx(l,{container:!0,spacing:3,justifyContent:"center",children:Object.keys(A).map(s=>{var n,d,h,a,m;return e.jsx(l,{item:!0,children:e.jsxs(g,{sx:{display:"flex",flexDirection:"column",alignItems:"center",cursor:"pointer",border:j===s.name?"2px solid #1976d2":"2px solid transparent",p:2,width:100,height:100,justifyContent:"center",transition:"border 0.2s, background 0.2s","&:hover":{background:((n=J[s.name])==null?void 0:n.hoverBg)||"#eee",color:((d=J[s.name])==null?void 0:d.color)||"inherit"},"&:hover .MuiAvatar-root":{background:"transparent"}},onClick:()=>ne(s),children:[e.jsx(H,{sx:{bgcolor:j===s?(m=(a=(h=A[s])==null?void 0:h.props)==null?void 0:a.style)==null?void 0:m.color:"default",color:j===s?"#fff":"inherit",mb:1,width:48,height:48,transition:"background 0.2s, color 0.2s"},children:A[s]}),e.jsx(p,{variant:"body1",children:s})]})},s)})}),L&&e.jsx($,{severity:"success",sx:{mt:2},children:L}),k&&e.jsx($,{severity:"error",sx:{mt:2},children:k})]})})}),e.jsx(l,{size:{xs:12,md:12,lg:12},children:e.jsx(P,{title:"Connected Devices",secondary:e.jsx(V,{variant:"text",color:"primary",startIcon:e.jsx(ue,{}),onClick:ae,sx:{ml:2},children:"Add Device"}),children:S.length===0?e.jsx(p,{variant:"body2",color:"text.secondary",children:"No devices connected."}):e.jsx(_,{children:S.map(({platform:s,id:n})=>e.jsxs(O,{sx:{pl:0},children:[e.jsx(H,{sx:{mr:2,bgcolor:"transparent"},children:A[s]}),e.jsx(q,{primary:n,secondary:s})]},n))})})}),e.jsx(l,{size:{xs:12,md:12,lg:12},children:e.jsx(P,{sx:{mt:1},content:!1,children:e.jsx(g,{sx:{p:3}})})})]})}export{Ke as default};
